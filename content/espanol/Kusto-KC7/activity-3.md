---
title: "Activity 3: Kusto Query Language 101"
draft: false
weight: 12
---

<p style="text-align: center;"><iframe width="560" height="315" src="https://www.youtube.com/embed/lAeRxuUN1IM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></p>

{{< notice tip >}} Aqu√≠ queremos que abras el Scoreboard y el ADX viewer que usaste antes en ventanas separadas para completar los ejercicios restantes. Si no puedes o no quieres usar el Scoreboard, todas las preguntas de esta secci√≥n est√°n listadas abajo.

*Recuerda que cualquier p√°gina con un video duplica la lecci√≥n tanto en forma de video como escrita. Puedes seguir una u otra seg√∫n el tipo de aprendiz que seas.* {{< /notice >}}

## KQL 101

**[Aseg√∫rate de usar la base de datos SecurityLogs para este ejercicio.]**

Escribe la siguiente consulta en el √°rea de trabajo para ver las primeras filas de la tabla **Employees**. Presiona ‚Äúrun‚Äù o ‚Äúshift + enter‚Äù para ejecutar la consulta. Todos los bloques de c√≥digo KQL para este taller estar√°n delimitados en gris como el siguiente.

```KQL
Employees
|   take 10
```

Esta consulta tiene varias partes. Tom√©monos un momento para desglosarlas:

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL1.png?raw=true" alt= ‚ÄúKQL1‚Äù width="50%" height="value">

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL2.png?raw=true" alt= ‚ÄúKQL2‚Äù width="80%" height="value">

El operador <span style="color:red">**take**</span> es una herramienta poderosa que puedes usar para explorar filas en una tabla y, por lo tanto, comprender mejor qu√© tipo de datos se almacenan all√≠.

{{< notice note >}} üéØ**Punto clave ‚Äì Qu√© hacer cuando no sabes qu√© hacer**: Siempre que te enfrentes a una tabla de base de datos desconocida, lo primero que deber√≠as hacer es muestrear sus filas usando el operador <span style="color:red">**take**</span>. De ese modo, sabr√°s qu√© campos est√°n disponibles para consultar y podr√°s intuir qu√© tipo de informaci√≥n podr√≠as extraer de la fuente de datos. {{< /notice >}}

La tabla Employees contiene informaci√≥n sobre todos los empleados de nuestra organizaci√≥n. En este caso, podemos ver que la organizaci√≥n se llama ‚ÄúEnvolve Labs‚Äù y el dominio es ‚Äúenvolvelabs.com‚Äù.

{{< alert theme="success" >}}
*Pregunta 1. ü§î ¬°Pru√©balo t√∫ mismo! Haz un <span style="color:red">**take**</span> 10 en todas las dem√°s tablas para ver qu√© tipo de datos contienen.*{{< /alert >}}

Puedes escribir f√°cilmente m√∫ltiples consultas en la misma pesta√±a del √°rea de trabajo. Para hacerlo, aseg√∫rate de separar cada consulta con una l√≠nea vac√≠a. Observa abajo c√≥mo hemos separado las consultas para las tablas Employees, Email y OutboundBrowsing con l√≠neas vac√≠as en las l√≠neas 3 y 6.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL3.png?raw=true" alt= ‚ÄúKQL3‚Äù width="value" height="value">

Cuando tienes m√∫ltiples consultas, es importante indicar a ADX cu√°l quieres ejecutar. Para elegir una consulta, simplemente haz clic en cualquier l√≠nea que forme parte de esa consulta. Una vez seleccionada, se resaltar√° en azul, como se ve en las l√≠neas 4 y 5 arriba.

#### Encontrar ‚ÄúCu√°nto‚Äù: El operador 'count'

Podemos usar <span style="color:red">**count**</span> para ver cu√°ntas filas hay en una tabla. Esto nos dice cu√°nta informaci√≥n est√° almacenada.

```KQL
Employees
|   count
```
{{< alert theme="success" >}}
*Pregunta 2. ü§î ¬øCu√°ntos empleados hay en la empresa?*{{< /alert >}}

#### Filtrar datos con el operador 'where'

Hasta ahora, hemos ejecutado consultas que miran todo el contenido de la tabla. A menudo, en an√°lisis de ciberseguridad, solo queremos ver datos que cumplen un conjunto de condiciones o criterios. Para lograr esto, aplicamos filtros a columnas espec√≠ficas.

Podemos usar el operador <span style="color:red">**where**</span> en KQL para aplicar filtros a un campo particular. Por ejemplo, podemos encontrar a todos los empleados con el nombre ‚ÄúLinda‚Äù filtrando la columna name en la tabla **Employees**.

<span style="color:red">**where**</span> se escribe usando una estructura particular. Usa la tabla √∫til a continuaci√≥n para entender c√≥mo estructurar una sentencia <span style="color:red">**where**</span>.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL4.png?raw=true" alt= ‚ÄúKQL4‚Äù width="50%" height="value">

```KQL
Employees
|   where name has "Linda"
```
El operador <span style="color:blue">**has**</span> es √∫til aqu√≠ porque buscamos solo una coincidencia parcial. Si quisi√©ramos buscar un empleado con un nombre y apellido espec√≠ficos (una coincidencia exacta), usar√≠amos el operador ==:

```KQL
Employees
|   where name == "Linda Holbert"
```
{{< alert theme="success" >}}
*Pregunta 3. ü§î A cada empleado de Envolve Labs se le asigna una direcci√≥n IP. ¬øQu√© empleado tiene la direcci√≥n IP: ‚Äú192.168.0.191‚Äù?*{{< /alert >}}

Mientras realizan sus tareas diarias, los empleados de Envolve Labs env√≠an y reciben correos electr√≥nicos. Un registro de cada uno de estos correos se almacena en la tabla **Email**.

{{< notice note >}}üéØ**Punto clave ‚Äì Privacidad del usuario y metadatos**: Como puedes imaginar, algunos correos son altamente sensibles. En lugar de almacenar el contenido completo de cada correo enviado y recibido en la empresa en una base de datos de f√°cil acceso para analistas de seguridad, solo capturamos los metadatos del correo.

Los metadatos del correo incluyen informaci√≥n como: la hora en que se envi√≥ el correo, el remitente, el destinatario, la l√≠nea de asunto y cualquier enlace que el correo pueda contener. Almacenar solo metadatos en lugar del contenido completo ayuda a proteger la privacidad de nuestros empleados, a la vez que permite que nuestros analistas de seguridad nos mantengan a salvo. A veces incluso los metadatos pueden revelar informaci√≥n sensible, por lo que es importante que no hables sobre los datos de los registros con otros empleados fuera del SOC.{{< /notice >}}

Podemos encontrar informaci√≥n sobre los correos enviados o recibidos por un usuario buscando su direcci√≥n de correo en los campos sender y recipient de la tabla **Email**. Por ejemplo, podemos usar la siguiente consulta para ver todos los correos enviados por ‚ÄúMichael Montello‚Äù:

```KQL
Email
|   where sender == "michael_montello@envolvelabs.com"
```
{{< alert theme="success" >}}
*Pregunta 4. ü§î ¬øCu√°ntos correos recibi√≥ Betty Parrish?*{{< /alert >}}

#### Tan f√°cil como 1, 2, 3‚Ä¶ Consultas compuestas y el operador distinct

Podemos usar el operador distinct para encontrar valores √∫nicos en una columna particular. Podemos usar la siguiente consulta para determinar cu√°ntos usuarios de la organizaci√≥n enviaron correos.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL5.png?raw=true" alt= ‚ÄúKQL5‚Äù width="50%" height="value">

Esta es la primera vez que usamos una consulta de varias l√≠neas con m√∫ltiples operadores, as√≠ que desglos√©mosla:

En la **l√≠nea 2**, tomamos la tabla Email y filtramos los datos para encontrar solo aquellas filas con ‚Äúenvolvelabs‚Äù en la columna sender.

En la **l√≠nea 3**, a√±adimos otro car√°cter pipe ( | ) y usamos el operador distinct para encontrar todos los remitentes √∫nicos. Aqu√≠ no estamos encontrando los remitentes √∫nicos de todos los enviados de correo, sino solo los remitentes √∫nicos que quedan despu√©s de aplicar el filtro que busca filas con ‚Äúenvolvelabs‚Äù en la columna sender.

Finalmente, en la **l√≠nea 4**, a√±adimos otro car√°cter pipe ( | ) y luego usamos el operador count para contar los resultados de las l√≠neas 1-3 de la consulta.

{{< alert theme="success" >}}
*Pregunta 5. ü§î ¬øCu√°ntos usuarios recibieron correos con el t√©rmino ‚Äúvaccine‚Äù en el asunto?*{{< /alert >}}

#### Localizando un clic: datos de OutboundBrowsing

Cuando los empleados de Envolve Labs navegan a un sitio web desde la red corporativa, esa actividad de navegaci√≥n se registra. Esto se almacena en la tabla **OutboundBrowsing**, que contiene registros de los sitios web visitados por cada usuario de la empresa. Siempre que alguien visita un sitio web, se guarda un registro en la tabla. Sin embargo, el nombre del usuario no se almacena en la tabla, solo su direcci√≥n IP. Existe una relaci√≥n 1:1 entre los usuarios y sus direcciones IP asignadas, por lo que podemos consultar la tabla **Employees** para averiguar qui√©n naveg√≥ a un sitio web en particular.

Si queremos saber qu√© sitios web visit√≥ Annie Jackson, podemos encontrar su IP en la tabla **Employees**.

```KQL
Employees
|   where name == "Annie Jackson"
```
La consulta anterior nos indica que su IP es ‚Äú192.168.3.168‚Äù. Podemos tomar su direcci√≥n IP y buscar en la tabla **OutboundBrowsing** para determinar qu√© sitios visit√≥.

```KQL
OutboundBrowsing
| where src_ip == "192.168.3.168"
```

{{< alert theme="success" >}}
*Pregunta 6. ü§î ¬øA cu√°ntos sitios web √∫nicos visit√≥ ‚ÄúKeith Mitchell‚Äù?*{{< /alert >}}

#### ¬øQu√© hay en un nombre? Todo sobre datos de DNS pasivo

Aunque los nombres de dominio como ‚Äúgoogle.com‚Äù son f√°ciles de recordar para las personas, las computadoras no saben c√≥mo manejarlos. As√≠ que los convierten en direcciones IP legibles por m√°quinas. Al igual que tu direcci√≥n de casa le dice a tus amigos c√≥mo encontrar tu casa o departamento, una direcci√≥n IP le dice a tu equipo d√≥nde encontrar una p√°gina o servicio alojado en internet.

{{< notice note >}} üéØ**Punto clave ‚Äì Practica buena OPSEC**: Si queremos saber a qu√© direcci√≥n IP resuelve un dominio en particular, podr√≠amos simplemente navegar a √©l. Pero si el dominio es malicioso, podr√≠as descargar archivos maliciosos en tu sistema corporativo de an√°lisis o alertar a los atacantes de que conoces su infraestructura. Como analistas de ciberseguridad, debemos seguir procedimientos y salvaguardas que protejan nuestra capacidad para rastrear amenazas. Estas pr√°cticas se conocen generalmente como seguridad operacional, u OPSEC. {{< /notice >}}

Para eliminar la necesidad de resolver activamente (es decir, navegar directamente a o interactuar con un dominio para encontrar su direcci√≥n IP relacionada) cada dominio que nos interese, podemos confiar en datos de DNS pasivo. Los datos de DNS pasivo nos permiten explorar de forma segura las relaciones dominio‚ÄìIP, de modo que podamos responder preguntas como:

- ¬øA qu√© direcci√≥n IP resuelve este dominio?      
- ¬øQu√© dominios est√°n alojados en esta direcci√≥n IP?      
- ¬øA cu√°ntas otras IP ha resuelto este dominio?      

Estas relaciones dominio‚ÄìIP se almacenan en nuestra tabla **PassiveDns**.
{{< alert theme="success" >}}
*Pregunta 7. ü§î ¬øCu√°ntos dominios en los registros de **PassiveDns** contienen la palabra ‚Äúvaccine‚Äù? (pista: usa el operador <span style="color:blue">**contains**</span> en lugar de <span style="color:blue">**has**</span>. Si te quedas atascado, haz un <span style="color:red">**take**</span> 10 en la tabla para ver qu√© campos est√°n disponibles.)*

*Pregunta 8. ü§î ¬øA qu√© IPs resolvi√≥ el dominio ‚Äúbiotechenvolv.science‚Äù?*{{< /alert >}}

ü§Ø**Sentencias let ‚Äì facilit√°ndote la vida:**

A veces necesitamos usar la salida de una consulta como entrada para una segunda consulta. La primera forma de hacerlo es escribiendo manualmente los resultados en la siguiente consulta.

- Por ejemplo, ¬øy si queremos ver toda la actividad web de empleados llamados ‚ÄúLinda‚Äù?     
- Primero, tendr√≠as que ir a la tabla **Employees** y encontrar las direcciones IP usadas por esos empleados.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL6.png?raw=true" alt= ‚ÄúKQL6‚Äù width="80%" height="value">

Luego, podr√≠as copiar y pegar manualmente esas IP en una consulta contra la tabla **OutboundBrowsing**. Observa que podemos usar el operador in para elegir todas las filas que tengan un valor que coincida con cualquiera de los valores de una lista posible. En otras palabras, el operador == (comparaci√≥n) busca una coincidencia exacta, mientras que el operador in verifica cualquier valor de la lista.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL7.png?raw=true" alt= ‚ÄúKQL7‚Äù width="90%" height="value">

Aunque esto es una forma v√°lida de obtener la informaci√≥n que necesitas, puede que no sea tan elegante (o r√°pido) si tuvieras 100 o incluso 1000 empleados llamados ‚ÄúLinda‚Äù.

Podemos lograr esto de una manera m√°s elegante usando una [sentencia let](https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/letstatement), que nos permite asignar un nombre a una expresi√≥n o a una funci√≥n. Podemos usar una sentencia <span style="color:blue">**let**</span> aqu√≠ para guardar y dar un nombre a los resultados de la primera consulta para que los valores puedan reutilizarse m√°s tarde. Eso significa que no tenemos que escribir manualmente o copiar y pegar los resultados repetidamente.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL8.png?raw=true" alt= ‚ÄúKQL8‚Äù width="value" height="value">

A la izquierda de la sentencia <span style="color:blue">**let**</span> est√° el nombre de la variable (‚Äúlinda_ips‚Äù en este caso). El nombre de la variable puede ser lo que queramos, pero es √∫til poner algo significativo que nos ayude a recordar qu√© valores est√° almacenando.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL9.png?raw=true" alt= ‚ÄúKQL9‚Äù width="value" height="value">

En el lado derecho de la sentencia <span style="color:blue">**let**</span> va la expresi√≥n que est√°s almacenando. En este caso, usamos el operador <span style="color:red">**distinct**</span> para seleccionar valores de solo una columna ‚Äì de modo que se almacenen en un arreglo o lista de valores.

<img src= "https://github.com/bgrant34/workshops/blob/master/content/english/kusto-kc7/Images/KQL10.png?raw=true" alt= ‚ÄúKQL10‚Äù width="value" height="value">

La sentencia <span style="color:blue">**let**</span> se concluye con un punto y coma.

Despu√©s de almacenar el valor de una consulta en una variable usando la sentencia <span style="color:blue">**let**</span>, podemos referirnos a ella tantas veces como queramos en el resto de la consulta. La consulta almacenada no muestra salida. Recuerda, sin embargo, que tu consulta KQL debe tener una sentencia tabular ‚Äì lo que significa que debes tener otra consulta despu√©s de tu sentencia <span style="color:blue">**let**</span>.
{{< alert theme="success" >}}
*Pregunta 9. ü§î ¬øCu√°ntas URLs √∫nicas fueron navegadas por empleados llamados ‚ÄúKaren‚Äù?*{{< /alert >}}


{{< notice note >}}üéØ**Punto clave ‚Äì Pivotar**: Parte de ser un gran analista es aprender a usar m√∫ltiples fuentes de datos para contar una historia m√°s completa de lo que un atacante hizo. A esto lo llamamos ‚Äúpivotar‚Äù. Pivotamos tomando un dato conocido en un conjunto de datos y buscando en otro conjunto de datos para aprender algo que no sab√≠amos. Practicaste esto aqu√≠ cuando partimos de un conjunto de datos ‚Äì la tabla Employees ‚Äì y usamos ese conocimiento para encontrar datos relacionados en otra fuente ‚Äì **OutboundBrowsing**. {{< /notice >}}